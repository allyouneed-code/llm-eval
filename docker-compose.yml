
services:
  # 1. 前端服务 (Nginx + Vue)
  frontend:
    image: my-llm-eval-frontend:v1
    build: ./frontend
    ports:
      - "8080:80"  # 浏览器访问 http://localhost
    depends_on:
      - backend
    restart: always

  # 2. 后端 API 服务
  backend:
    image: my-llm-eval-backend:v1
    build: ./backend
    environment:
      - DATABASE_URL=mysql+pymysql://user:password@db:3306/opencompass_db
      - CELERY_BROKER_URL=redis://redis:6379/0
    ports:
      - "8000:8000"
    depends_on:
      - db
      - redis
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    restart: always
    volumes:
      - ./backend/workspace:/app/workspace
      - ./backend/data:/app/data

  # 3. Celery Worker (异步任务)
  celery_worker:
    build: ./backend
    environment:
      - DATABASE_URL=mysql+pymysql://user:password@db:3306/opencompass_db
      - CELERY_BROKER_URL=redis://redis:6379/0
    depends_on:
      - backend
      - redis
    # 启动命令改为 celery worker
    command: celery -A app.worker.celery_app worker --loglevel=info
    restart: always
    volumes:
      - ./backend/workspace:/app/workspace
      - ./backend/data:/app/data
      - ./backend/debug_test:/app/debug_test

  # 4. Redis
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # 5. MySQL 数据库
  db:
    image: mysql:8.0
    # 1. 强制指定平台，解决架构不匹配问题
    platform: linux/amd64 
    environment:
      MYSQL_DATABASE: opencompass_db
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_ROOT_PASSWORD: rootpassword
    volumes:
      - db_data:/var/lib/mysql
    # 2. 追加 --innodb-use-native-aio=0 解决 AIO 报错
    command: --default-authentication-plugin=mysql_native_password --innodb-use-native-aio=0

volumes:
  redis_data:
  db_data: